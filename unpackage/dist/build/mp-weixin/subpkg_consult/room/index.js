"use strict";const e=require("../../common/vendor.js"),s=require("../../stores/user.js"),t=require("../../services/consult.js");if(require("../../utils/http.js"),!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-icons"))()}Math||(o+n+i+u+a+r+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js"))();const o=()=>"./components/room-status.js",n=()=>"./components/patient-info.js",i=()=>"./components/notify-info.js",u=()=>"./components/message-info.js",a=()=>"./components/prescription-info.js",r=()=>"./components/rate-info.js",c={__name:"index",props:{orderId:String},setup(o){const n=o,{token:i,userId:u}=s.useUserStore(),a=e.ref([]),r=e.ref({}),c=e.ref(""),p=e.ref(!1),l=e.ref(e.dayjs().format("YYYY-MM-DD HH:mm:ss")),d=e.lookup("https://consult-api.itheima.net",{auth:{token:"Bearer "+i},query:{orderId:n.orderId},transports:["websocket","polling"],timeout:5e3});function m(){p.value=!0,d.emit("getChatMsgList",20,l.value,n.orderId)}function g(){var e,s;d.emit("sendChatMsg",{from:u,to:null==(s=null==(e=r.value)?void 0:e.docInfo)?void 0:s.id,msgType:1,msg:{content:c.value}}),c.value=""}function f(){if(3!==r.value.status)return e.index.utils.toast("医生当前不在线!");e.Ds.chooseAndUploadFile({type:"image",count:1,extension:[".jpg",".png","gif"],success:({tempFiles:e})=>{var s,t;const o={id:e[0].lastModified,url:e[0].url};d.emit("sendChatMsg",{from:u,to:null==(t=null==(s=r.value)?void 0:s.docInfo)?void 0:t.id,msgType:4,msg:{picture:o}})}})}async function v(){const{code:s,data:o,message:i}=await t.orderDetailApi(n.orderId);if(1e4!==s)return e.index.utils.toast(i);r.value=o}return d.on("chatMsgList",(({code:s,data:t})=>{if(p.value=!1,1e4!==s)return;const o=[];if(t.forEach((({createTime:e,items:s},t)=>{0===t&&(l.value=e),o.push({msgType:31,msg:{content:e},id:e},...s)})),0===o.length)return e.index.utils.toast("没有更多聊天记录了");a.value.unshift(...o)})),d.on("receiveChatMsg",(e=>{d.emit("updateMsgStatus",e.id),a.value.push(e)})),d.on("statusChange",v),v(),(s,t)=>e.e({a:e.p({"status-value":r.value.statusValue,countdown:r.value.countdown,status:r.value.status}),b:e.f(a.value,((s,t,o)=>{var i;return e.e({a:21===s.msgType},21===s.msgType?{b:"0f0516ec-1-"+o,c:e.p({info:s.msg.consultRecord})}:{},{d:s.msgType>=31},s.msgType>=31?{e:e.t(s.msg.content),f:"0f0516ec-2-"+o,g:e.p({type:s.msgType})}:{},{h:s.msgType<=4},s.msgType<=4?{i:"0f0516ec-3-"+o,j:e.p({info:s,type:s.msgType})}:{},{k:22===s.msgType},22===s.msgType?{l:"0f0516ec-4-"+o,m:e.p({info:s.msg.prescription})}:{},{n:23===s.msgType},23===s.msgType?{o:"0f0516ec-5-"+o,p:e.p({"order-id":n.orderId,"doctor-id":null==(i=r.value.docInfo)?void 0:i.id})}:{},{q:24===s.msgType},24===s.msgType?{r:"0f0516ec-6-"+o,s:e.p({evaluateDoc:s.msg.evaluateDoc,"has-evaluate":!0})}:{},{t:s.id})})),c:e.o(m),d:p.value},{e:e.o(g),f:e.o((e=>c.value=e)),g:e.p({disabled:3!==r.value.status,clearable:!1,"input-border":!1,"placeholder-style":"font-size: 32rpx; color: #c3c3c5;",placeholder:"问医生",modelValue:c.value}),h:e.p({size:"40",color:"#979797",type:"image"}),i:e.o(f)})}};wx.createPage(c);
